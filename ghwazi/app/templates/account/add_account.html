{% extends "main/base.html" %}

{% block title %}{{ _('Add Bank Account') }} - Bank Email Parser{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce() }}">
document.addEventListener('DOMContentLoaded', function() {
    // Get the bank_id and currency elements
    const bankSelect = document.getElementById('bank_id');
    const currencyInput = document.getElementById('currency');
    const bankNameInput = document.getElementById('bank_name');
    const accountNumberInput = document.getElementById('account_number');
    const validationMessage = document.getElementById('account-validation-message');

    // Normalize Arabic-Indic digits (٠١٢٣٤٥٦٧٨٩ and ۰۱۲۳۴۵۶۷۸۹) to ASCII 0-9
    function normalizeDigits(str) {
        if (!str) return str;
        return str
            .replace(/[\u0660-\u0669]/g, d => String(d.charCodeAt(0) - 0x0660))
            .replace(/[\u06F0-\u06F9]/g, d => String(d.charCodeAt(0) - 0x06F0));
    }

    // Account number input masking and validation
    function formatAccountNumber(value) {
        // Remove all non-digits
        const digits = value.replace(/\D/g, '');
        // Add spaces every 4 digits
        return digits.replace(/(\d{4})(?=\d)/g, '$1 ');
    }

    function validateAccountNumber(value) {
        const digits = value.replace(/\D/g, '');
        const isValid = digits.length === 16;
        const isComplete = digits.length === 16;
        const isPartial = digits.length > 0 && digits.length < 16;

        return {
            isValid,
            isComplete,
            isPartial,
            digitCount: digits.length,
            cleanValue: digits
        };
    }

    function showValidationMessage(type, message) {
        validationMessage.textContent = message;
        validationMessage.className = `form-text validation-message ${type}`;
        validationMessage.style.display = 'block';
    }

    function hideValidationMessage() {
        validationMessage.style.display = 'none';
    }

    // Account number input event handlers
    accountNumberInput.addEventListener('input', function(e) {
        const cursorPosition = e.target.selectionStart;
        const oldValue = e.target.value;
        const normalized = normalizeDigits(e.target.value);
        const formatted = formatAccountNumber(normalized);
        const validation = validateAccountNumber(formatted);

        // Update input value with formatting
        e.target.value = formatted;

        // Restore cursor position accounting for added spaces
        const spacesAdded = formatted.length - oldValue.replace(/\s/g, '').length;
        e.target.setSelectionRange(cursorPosition + spacesAdded, cursorPosition + spacesAdded);

        // Show validation feedback
        if (validation.digitCount === 0) {
            hideValidationMessage();
            e.target.classList.remove('is-valid', 'is-invalid');
        } else if (validation.isComplete) {
            showValidationMessage('success', '✓ Valid account number format');
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else if (validation.isPartial) {
            const missingDigits = 16 - validation.digitCount;
            showValidationMessage('warning', `${missingDigits} digits missing`);
            e.target.classList.remove('is-valid', 'is-invalid');
        }

        // Update the hidden input value (clean digits only for form submission)
        e.target.setAttribute('data-clean-value', validation.cleanValue);
    });

    // Prevent non-numeric input
    accountNumberInput.addEventListener('keydown', function(e) {
        // Allow: backspace, delete, tab, escape, enter
        if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true) ||
            // Allow: home, end, left, right, down, up
            (e.keyCode >= 35 && e.keyCode <= 40)) {
            return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    });

    // Handle paste events
    accountNumberInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = normalizeDigits(paste).replace(/\D/g, '');
        if (digits.length <= 16) {
            e.target.value = formatAccountNumber(digits);
            e.target.dispatchEvent(new Event('input'));
        }
    });

    // Form submission handler - ensure clean value is submitted
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const cleanValue = accountNumberInput.getAttribute('data-clean-value') || '';
        const validation = validateAccountNumber(cleanValue);

        if (!validation.isComplete) {
            e.preventDefault();
            showValidationMessage('error', 'Please enter a complete 16-digit account number');
            accountNumberInput.classList.add('is-invalid');
            accountNumberInput.focus();
            return false;
        }

        // Set the clean value for submission
        accountNumberInput.value = cleanValue;
    });

    // Add event listener to update currency and email preview when bank is selected
    bankSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];

        if (selectedOption.value) {
            // Get currency from data attribute
            const currency = selectedOption.getAttribute('data-currency');
            currencyInput.value = currency;

            // Disable bank_name field when a bank is selected
            if (bankNameInput) {
                bankNameInput.disabled = true;
                bankNameInput.value = '';
            }

        } else {
            // Reset currency to default
            currencyInput.value = 'OMR';

            // Enable bank_name field when no bank is selected
            if (bankNameInput) {
                bankNameInput.disabled = false;
            }

        }
    });
});
</script>

<style>
.validation-message {
    margin-top: 0.25rem;
    font-size: 0.875em;
}

.validation-message.success {
    color: #28a745;
}

.validation-message.warning {
    color: #ffc107;
}

.validation-message.error {
    color: #dc3545;
}

.form-control.is-valid {
    border-color: #28a745;
}

.form-control.is-invalid {
    border-color: #dc3545;
}

#account_number {
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
    direction: ltr;
    unicode-bidi: isolate;
    text-align: left;
}
</style>
{% endblock %}


{% block content %}
<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">{{ _("Dashboard") }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ _("Add Bank Account") }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-6 offset-md-3">
        <div class="card{% if text_direction == 'rtl' %} text-end{% endif %}">
            <div class="card-header">
                <h3>{{ _("Add Bank Account") }}</h3>
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="account_number" class="form-label">{{ _("Account Number") }} *</label>
                        <input type="text" class="form-control" id="account_number" name="account_number" dir="ltr" inputmode="numeric" required autocomplete="off" placeholder="0000 0000 0000 0000" maxlength="19" minlength="16">
                        <div id="account-validation-message" class="form-text validation-message" style="display: none;"></div>
                        <div class="form-text">{{ _("Account number must be 16 digits.") }} </div>
                    </div>


                    <div class="mb-3">
                        <label for="bank_id" class="form-label">{{ _("Bank") }} *</label>
                        <select class="form-select" id="bank_id" name="bank_id" required>
                            <option value="">{{ _("-- Select a Bank --") }}</option>
                            {% for bank in banks %}
                                <option value="{{ bank.id }}" data-currency="{{ bank.currency }}">{{ bank.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{{ _("Select your bank from the list.") }}</div>
                    </div>


                    <div class="mb-3">
                        <label for="account_holder" class="form-label">{{ _("Account Holder") }}</label>
                        <input type="text" class="form-control" id="account_holder" name="account_holder">
                        <div class="form-text">{{ _("Enter the name of the account holder.") }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="balance" class="form-label">{{ _("Current Balance") }}</label>
                        <input type="number" class="form-control" id="balance" name="balance" step="0.001" value="0.000">
                        <div class="form-text">{{ _("Enter the current balance of your account.") }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="currency" class="form-label">{{ _("Currency") }}</label>
                        <input type="text" class="form-control" id="currency" name="currency" value="OMR" readonly>
                        <div class="form-text">{{ _("Currency is automatically set based on the selected bank.") }}</div>
                    </div>


                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">{{ _("Cancel") }}</a>
                        <button type="submit" class="btn btn-primary">{{ _("Add Account") }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
